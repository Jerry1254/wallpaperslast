(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[240],{9534:function(e,s,r){"use strict";r.d(s,{Z:function(){return t}});var a=r(65531);/**
 * @license lucide-react v0.454.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let t=(0,a.Z)("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]])},28979:function(e,s,r){Promise.resolve().then(r.bind(r,20783))},20783:function(e,s,r){"use strict";r.r(s),r.d(s,{default:function(){return UsersPage}});var a=r(26705),t=r(20955),n=r(56731),i=r(65531);/**
 * @license lucide-react v0.454.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */let l=(0,i.Z)("Pencil",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]]),o=(0,i.Z)("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]);var d=r(23611),c=r(66005),u=r(71271),h=r(98965),m=r(62031),p=r(35831),f=r(61465);function EditUserModal(e){let{open:s,onOpenChange:r,user:n,onSuccess:i}=e,[l,o]=(0,t.useState)(!1),[c,h]=(0,t.useState)({oldPassword:"",newPassword:"",confirmPassword:""}),[w,x]=(0,t.useState)({}),validatePassword=e=>{if(e.length<8)return"密码长度至少8位";let s=0;return(/[A-Z]/.test(e)&&s++,/[a-z]/.test(e)&&s++,/[0-9]/.test(e)&&s++,/[^A-Za-z0-9]/.test(e)&&s++,s<3)?"密码需包含大写字母、小写字母、数字、特殊符号中的至少三种":""},validateForm=async()=>{let e={};if(c.oldPassword||(e.oldPassword="原密码不能为空"),c.newPassword||(e.newPassword="新密码不能为空"),c.confirmPassword||(e.confirmPassword="确认密码不能为空"),c.newPassword){let s=validatePassword(c.newPassword);s&&(e.newPassword=s)}if(c.newPassword!==c.confirmPassword&&(e.confirmPassword="两次输入的密码不一致"),c.oldPassword&&!e.oldPassword&&n)try{let s=await fetch("/api/users/".concat(n.id,"/verify-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:c.oldPassword})}),r=await s.json();r.valid||(e.oldPassword="原密码错误")}catch(s){e.oldPassword="验证原密码失败"}return x(e),0===Object.keys(e).length},handleSubmit=async e=>{if(e.preventDefault(),n){o(!0);try{let e=await validateForm();if(!e){o(!1);return}let s=await fetch("/api/users/".concat(n.id,"/change-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPassword:c.oldPassword,newPassword:c.newPassword})});if(!s.ok){let e=await s.json();throw Error(e.error||"修改密码失败")}(0,u.Am)({description:"密码修改成功！"}),r(!1),null==i||i(),h({oldPassword:"",newPassword:"",confirmPassword:""}),x({})}catch(e){(0,u.Am)({variant:"destructive",description:e.message||"修改密码失败，请重试"})}finally{o(!1)}}};return n?(0,a.jsx)(m.Vq,{open:s,onOpenChange:r,children:(0,a.jsxs)(m.cZ,{className:"sm:max-w-[425px] max-h-[85vh] overflow-y-auto",children:[(0,a.jsx)(m.fK,{children:(0,a.jsx)(m.$N,{children:"修改用户密码"})}),(0,a.jsxs)("form",{onSubmit:handleSubmit,className:"space-y-4 py-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(f._,{htmlFor:"username",children:"用户名"}),(0,a.jsx)(p.I,{id:"username",value:n.username,disabled:!0})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(f._,{htmlFor:"oldPassword",children:"原密码"}),(0,a.jsx)(p.I,{id:"oldPassword",type:"password",value:c.oldPassword,onChange:e=>h(s=>({...s,oldPassword:e.target.value}))}),w.oldPassword&&(0,a.jsx)("p",{className:"text-sm text-red-500",children:w.oldPassword})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(f._,{htmlFor:"newPassword",children:"新密码"}),(0,a.jsx)(p.I,{id:"newPassword",type:"password",value:c.newPassword,onChange:e=>h(s=>({...s,newPassword:e.target.value}))}),w.newPassword&&(0,a.jsx)("p",{className:"text-sm text-red-500",children:w.newPassword})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(f._,{htmlFor:"confirmPassword",children:"确认新密码"}),(0,a.jsx)(p.I,{id:"confirmPassword",type:"password",value:c.confirmPassword,onChange:e=>h(s=>({...s,confirmPassword:e.target.value}))}),w.confirmPassword&&(0,a.jsx)("p",{className:"text-sm text-red-500",children:w.confirmPassword})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-4 pt-4",children:[(0,a.jsx)(d.z,{type:"button",variant:"outline",onClick:()=>r(!1),children:"取消"}),(0,a.jsx)(d.z,{type:"submit",disabled:l,children:l?"修改中...":"修改密码"})]})]})]})}):null}var w=r(69710);function UserList(){let[e,s]=(0,t.useState)([]),[r,n]=(0,t.useState)(!0),[i,m]=(0,t.useState)(1),[p,f]=(0,t.useState)(!1),[x,j]=(0,t.useState)(null),[v,y]=(0,t.useState)(!1),[g,P]=(0,t.useState)(null),fetchUsers=async()=>{try{n(!0);let e=await fetch("/api/users");if(!e.ok)throw Error("Failed to fetch users");let r=await e.json();s(r)}catch(e){(0,u.Am)({variant:"destructive",description:"获取用户列表失败"})}finally{n(!1)}};(0,t.useEffect)(()=>{fetchUsers()},[]);let N=Math.ceil(e.length/20),b=(i-1)*20,C=e.slice(b,b+20),handlePageChange=e=>{m(e)},handleDeleteClick=e=>{P(e),y(!0)},handleDeleteConfirm=async()=>{if(g)try{let e=await fetch("/api/users/".concat(g),{method:"DELETE"});if(!e.ok){let s=await e.json();throw Error(s.error||"删除用户失败")}(0,u.Am)({description:"用户删除成功"}),fetchUsers()}catch(e){(0,u.Am)({variant:"destructive",description:e.message||"删除用户失败"})}finally{y(!1),P(null)}},handleEdit=e=>{j(e),f(!0)};return r?(0,a.jsx)("div",{className:"text-center py-4",children:"加载中..."}):(0,a.jsxs)("div",{className:"rounded-md border",children:[(0,a.jsxs)(c.iA,{children:[(0,a.jsx)(c.xD,{children:(0,a.jsxs)(c.SC,{children:[(0,a.jsx)(c.ss,{children:"用户名"}),(0,a.jsx)(c.ss,{children:"角色"}),(0,a.jsx)(c.ss,{children:"创建时间"}),(0,a.jsx)(c.ss,{className:"w-[100px]",children:"操作"})]})}),(0,a.jsx)(c.RM,{children:C.map(e=>(0,a.jsxs)(c.SC,{children:[(0,a.jsx)(c.pj,{className:"font-medium",children:e.username}),(0,a.jsx)(c.pj,{children:"admin"===e.role?"管理员":"核销员"}),(0,a.jsx)(c.pj,{children:new Date(e.createdAt).toLocaleDateString()}),(0,a.jsx)(c.pj,{children:(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(d.z,{variant:"ghost",size:"icon",onClick:()=>handleEdit(e),children:(0,a.jsx)(l,{className:"h-4 w-4"})}),(0,a.jsx)(d.z,{variant:"ghost",size:"icon",onClick:()=>handleDeleteClick(e.id),children:(0,a.jsx)(o,{className:"h-4 w-4"})})]})})]},e.id))})]}),N>1&&(0,a.jsx)("div",{className:"py-4 flex justify-center",children:(0,a.jsx)(h.tl,{children:(0,a.jsxs)(h.ng,{children:[(0,a.jsx)(h.nt,{children:(0,a.jsx)(h.dN,{onClick:()=>handlePageChange(i-1),disabled:1===i})}),Array.from({length:N}).map((e,s)=>(0,a.jsx)(h.nt,{children:(0,a.jsx)(h.kN,{onClick:()=>handlePageChange(s+1),isActive:i===s+1,children:s+1})},s)),(0,a.jsx)(h.nt,{children:(0,a.jsx)(h.$0,{onClick:()=>handlePageChange(i+1),disabled:i===N})})]})})}),(0,a.jsx)(EditUserModal,{open:p,onOpenChange:f,user:x,onSuccess:fetchUsers}),(0,a.jsx)(w.Q,{open:v,onOpenChange:y,title:"删除用户",description:"确定要删除这个用户吗？此操作不可恢复。",onConfirm:handleDeleteConfirm})]})}var x=r(7532);function AddUserModal(e){let{open:s,onOpenChange:r,onSuccess:n}=e,[i,l]=(0,t.useState)(!1),[o,c]=(0,t.useState)({username:"",password:"",confirmPassword:"",role:""}),[h,w]=(0,t.useState)({}),validatePassword=e=>{if(e.length<8)return"密码长度至少8位";let s=0;return(/[A-Z]/.test(e)&&s++,/[a-z]/.test(e)&&s++,/[0-9]/.test(e)&&s++,/[^A-Za-z0-9]/.test(e)&&s++,s<3)?"密码需包含大写字母、小写字母、数字、特殊符号中的至少三种":""},validateForm=async()=>{let e={};o.username||(e.username="用户名不能为空"),o.password||(e.password="密码不能为空"),o.confirmPassword||(e.confirmPassword="确认密码不能为空"),o.role||(e.role="请选择角色");let s=validatePassword(o.password);if(s&&(e.password=s),o.password!==o.confirmPassword&&(e.confirmPassword="两次输入的密码不一致"),o.username&&!e.username)try{let s=await fetch("/api/users/check-username?username="+encodeURIComponent(o.username)),r=await s.json();r.available||(e.username="用户名已存在")}catch(s){e.username="验证用户名失败"}return w(e),0===Object.keys(e).length},handleSubmit=async e=>{e.preventDefault(),l(!0);try{let e=await validateForm();if(!e){l(!1);return}let s=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:o.username,password:o.password,role:o.role})});if(!s.ok){let e=await s.json();throw Error(e.error||"创建用户失败")}(0,u.Am)({description:"用户创建成功！"}),r(!1),null==n||n(),c({username:"",password:"",confirmPassword:"",role:""}),w({})}catch(e){(0,u.Am)({variant:"destructive",description:e.message||"创建用户失败，请重试"})}finally{l(!1)}};return(0,a.jsx)(m.Vq,{open:s,onOpenChange:r,children:(0,a.jsxs)(m.cZ,{children:[(0,a.jsx)(m.fK,{children:(0,a.jsx)(m.$N,{children:"新增用户"})}),(0,a.jsxs)("form",{onSubmit:handleSubmit,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(f._,{htmlFor:"username",children:"用户名"}),(0,a.jsx)(p.I,{id:"username",value:o.username,onChange:e=>c(s=>({...s,username:e.target.value})),error:h.username}),h.username&&(0,a.jsx)("p",{className:"text-sm text-red-500",children:h.username})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(f._,{htmlFor:"password",children:"密码"}),(0,a.jsx)(p.I,{id:"password",type:"password",value:o.password,onChange:e=>c(s=>({...s,password:e.target.value})),error:h.password}),h.password&&(0,a.jsx)("p",{className:"text-sm text-red-500",children:h.password})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(f._,{htmlFor:"confirmPassword",children:"确认密码"}),(0,a.jsx)(p.I,{id:"confirmPassword",type:"password",value:o.confirmPassword,onChange:e=>c(s=>({...s,confirmPassword:e.target.value})),error:h.confirmPassword}),h.confirmPassword&&(0,a.jsx)("p",{className:"text-sm text-red-500",children:h.confirmPassword})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(f._,{htmlFor:"role",children:"角色"}),(0,a.jsxs)(x.Ph,{value:o.role,onValueChange:e=>c(s=>({...s,role:e})),children:[(0,a.jsx)(x.i4,{children:(0,a.jsx)(x.ki,{placeholder:"选择角色"})}),(0,a.jsxs)(x.Bw,{children:[(0,a.jsx)(x.Ql,{value:"admin",children:"管理员"}),(0,a.jsx)(x.Ql,{value:"user",children:"核销员"})]})]}),h.role&&(0,a.jsx)("p",{className:"text-sm text-red-500",children:h.role})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-2",children:[(0,a.jsx)(d.z,{variant:"outline",type:"button",onClick:()=>r(!1),children:"取消"}),(0,a.jsx)(d.z,{type:"submit",disabled:i,children:i?"创建中...":"确定"})]})]})]})})}function UsersPage(){let[e,s]=(0,t.useState)(!1),[r,i]=(0,t.useState)(0);return(0,a.jsxs)(n.AdminLayout,{children:[(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold",children:"用户管理"}),(0,a.jsx)(d.z,{variant:"default",onClick:()=>s(!0),children:"新增用户"})]})}),(0,a.jsx)(UserList,{},r),(0,a.jsx)(AddUserModal,{open:e,onOpenChange:s,onSuccess:()=>{i(e=>e+1)}})]})}},52506:function(e,s,r){"use strict";r.d(s,{$j:function(){return F},Dx:function(){return _},VY:function(){return z},aU:function(){return E},aV:function(){return O},dk:function(){return U},fC:function(){return D},h_:function(){return S},xz:function(){return k}});var a=r(20955),t=r(56989),n=r(42210),i=r(28712),l=r(85744),o=r(67256),d=r(26705),c="AlertDialog",[u,h]=(0,t.b)(c,[i.p8]),m=(0,i.p8)(),AlertDialog=e=>{let{__scopeAlertDialog:s,...r}=e,a=m(s);return(0,d.jsx)(i.fC,{...a,...r,modal:!0})};AlertDialog.displayName=c;var p=a.forwardRef((e,s)=>{let{__scopeAlertDialog:r,...a}=e,t=m(r);return(0,d.jsx)(i.xz,{...t,...a,ref:s})});p.displayName="AlertDialogTrigger";var AlertDialogPortal=e=>{let{__scopeAlertDialog:s,...r}=e,a=m(s);return(0,d.jsx)(i.h_,{...a,...r})};AlertDialogPortal.displayName="AlertDialogPortal";var f=a.forwardRef((e,s)=>{let{__scopeAlertDialog:r,...a}=e,t=m(r);return(0,d.jsx)(i.aV,{...t,...a,ref:s})});f.displayName="AlertDialogOverlay";var w="AlertDialogContent",[x,j]=u(w),v=a.forwardRef((e,s)=>{let{__scopeAlertDialog:r,children:t,...c}=e,u=m(r),h=a.useRef(null),p=(0,n.e)(s,h),f=a.useRef(null);return(0,d.jsx)(i.jm,{contentName:w,titleName:y,docsSlug:"alert-dialog",children:(0,d.jsx)(x,{scope:r,cancelRef:f,children:(0,d.jsxs)(i.VY,{role:"alertdialog",...u,...c,ref:p,onOpenAutoFocus:(0,l.M)(c.onOpenAutoFocus,e=>{e.preventDefault(),f.current?.focus({preventScroll:!0})}),onPointerDownOutside:e=>e.preventDefault(),onInteractOutside:e=>e.preventDefault(),children:[(0,d.jsx)(o.A4,{children:t}),(0,d.jsx)(DescriptionWarning,{contentRef:h})]})})})});v.displayName=w;var y="AlertDialogTitle",g=a.forwardRef((e,s)=>{let{__scopeAlertDialog:r,...a}=e,t=m(r);return(0,d.jsx)(i.Dx,{...t,...a,ref:s})});g.displayName=y;var P="AlertDialogDescription",N=a.forwardRef((e,s)=>{let{__scopeAlertDialog:r,...a}=e,t=m(r);return(0,d.jsx)(i.dk,{...t,...a,ref:s})});N.displayName=P;var b=a.forwardRef((e,s)=>{let{__scopeAlertDialog:r,...a}=e,t=m(r);return(0,d.jsx)(i.x8,{...t,...a,ref:s})});b.displayName="AlertDialogAction";var C="AlertDialogCancel",A=a.forwardRef((e,s)=>{let{__scopeAlertDialog:r,...a}=e,{cancelRef:t}=j(C,r),l=m(r),o=(0,n.e)(s,t);return(0,d.jsx)(i.x8,{...l,...a,ref:o})});A.displayName=C;var DescriptionWarning=({contentRef:e})=>{let s=`\`${w}\` requires a description for the component to be accessible for screen reader users.

You can add a description to the \`${w}\` by passing a \`${P}\` component as a child, which also benefits sighted users by adding visible context to the dialog.

Alternatively, you can use your own component as a description by assigning it an \`id\` and passing the same value to the \`aria-describedby\` prop in \`${w}\`. If the description is confusing or duplicative for sighted users, you can use the \`@radix-ui/react-visually-hidden\` primitive as a wrapper around your description component.

For more information, see https://radix-ui.com/primitives/docs/components/alert-dialog`;return a.useEffect(()=>{let r=document.getElementById(e.current?.getAttribute("aria-describedby"));r||console.warn(s)},[s,e]),null},D=AlertDialog,k=p,S=AlertDialogPortal,O=f,z=v,E=b,F=A,_=g,U=N},36743:function(e,s,r){"use strict";r.d(s,{f:function(){return l}});var a=r(20955),t=r(9381),n=r(26705),i=a.forwardRef((e,s)=>(0,n.jsx)(t.WV.label,{...e,ref:s,onMouseDown:s=>{let r=s.target;r.closest("button, input, select, textarea")||(e.onMouseDown?.(s),!s.defaultPrevented&&s.detail>1&&s.preventDefault())}}));i.displayName="Label";var l=i}},function(e){e.O(0,[371,899,705,839,293,362,121,290,744],function(){return e(e.s=28979)}),_N_E=e.O()}]);