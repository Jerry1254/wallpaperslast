(()=>{var e={};e.id=6240,e.ids=[6240],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},55403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},94749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},41790:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page-experimental.runtime.prod.js")},85966:(e,s,r)=>{"use strict";r.r(s),r.d(s,{GlobalError:()=>i.a,__next_app__:()=>m,originalPathname:()=>h,pages:()=>c,routeModule:()=>p,tree:()=>l});var a=r(67096),t=r(16132),n=r(37284),i=r.n(n),d=r(32564),o={};for(let e in d)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(o[e]=()=>d[e]);r.d(s,o);let l=["",{children:["users",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,7498)),"/Users/kele/Desktop/aicode/wallpaper-admin-last/app/users/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,35345)),"/Users/kele/Desktop/aicode/wallpaper-admin-last/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(r.t.bind(r,9291,23)),"next/dist/client/components/not-found-error"]}],c=["/Users/kele/Desktop/aicode/wallpaper-admin-last/app/users/page.tsx"],h="/users/page",m={require:r,loadChunk:()=>Promise.resolve()},p=new a.AppPageRouteModule({definition:{kind:t.x.APP_PAGE,page:"/users/page",pathname:"/users",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:l}})},89886:(e,s,r)=>{Promise.resolve().then(r.bind(r,99315))},99315:(e,s,r)=>{"use strict";r.r(s),r.d(s,{default:()=>UsersPage});var a=r(30784),t=r(9885),n=r(57230),i=r(95196),d=r(51734),o=r(95555),l=r(13422),c=r(12025),h=r(47917),m=r(40516),p=r(33770),u=r(32451);function EditUserModal({open:e,onOpenChange:s,user:r,onSuccess:n}){let[i,d]=(0,t.useState)(!1),[l,h]=(0,t.useState)({oldPassword:"",newPassword:"",confirmPassword:""}),[x,w]=(0,t.useState)({}),validatePassword=e=>{if(e.length<8)return"密码长度至少8位";let s=0;return(/[A-Z]/.test(e)&&s++,/[a-z]/.test(e)&&s++,/[0-9]/.test(e)&&s++,/[^A-Za-z0-9]/.test(e)&&s++,s<3)?"密码需包含大写字母、小写字母、数字、特殊符号中的至少三种":""},validateForm=async()=>{let e={};if(l.oldPassword||(e.oldPassword="原密码不能为空"),l.newPassword||(e.newPassword="新密码不能为空"),l.confirmPassword||(e.confirmPassword="确认密码不能为空"),l.newPassword){let s=validatePassword(l.newPassword);s&&(e.newPassword=s)}if(l.newPassword!==l.confirmPassword&&(e.confirmPassword="两次输入的密码不一致"),l.oldPassword&&!e.oldPassword&&r)try{let s=await fetch(`/api/users/${r.id}/verify-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:l.oldPassword})}),a=await s.json();a.valid||(e.oldPassword="原密码错误")}catch(s){e.oldPassword="验证原密码失败"}return w(e),0===Object.keys(e).length},handleSubmit=async e=>{if(e.preventDefault(),r){d(!0);try{let e=await validateForm();if(!e){d(!1);return}let a=await fetch(`/api/users/${r.id}/change-password`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({oldPassword:l.oldPassword,newPassword:l.newPassword})});if(!a.ok){let e=await a.json();throw Error(e.error||"修改密码失败")}(0,c.Am)({description:"密码修改成功！"}),s(!1),n?.(),h({oldPassword:"",newPassword:"",confirmPassword:""}),w({})}catch(e){(0,c.Am)({variant:"destructive",description:e.message||"修改密码失败，请重试"})}finally{d(!1)}}};return r?a.jsx(m.Vq,{open:e,onOpenChange:s,children:(0,a.jsxs)(m.cZ,{className:"sm:max-w-[425px] max-h-[85vh] overflow-y-auto",children:[a.jsx(m.fK,{children:a.jsx(m.$N,{children:"修改用户密码"})}),(0,a.jsxs)("form",{onSubmit:handleSubmit,className:"space-y-4 py-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx(u._,{htmlFor:"username",children:"用户名"}),a.jsx(p.I,{id:"username",value:r.username,disabled:!0})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx(u._,{htmlFor:"oldPassword",children:"原密码"}),a.jsx(p.I,{id:"oldPassword",type:"password",value:l.oldPassword,onChange:e=>h(s=>({...s,oldPassword:e.target.value}))}),x.oldPassword&&a.jsx("p",{className:"text-sm text-red-500",children:x.oldPassword})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx(u._,{htmlFor:"newPassword",children:"新密码"}),a.jsx(p.I,{id:"newPassword",type:"password",value:l.newPassword,onChange:e=>h(s=>({...s,newPassword:e.target.value}))}),x.newPassword&&a.jsx("p",{className:"text-sm text-red-500",children:x.newPassword})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx(u._,{htmlFor:"confirmPassword",children:"确认新密码"}),a.jsx(p.I,{id:"confirmPassword",type:"password",value:l.confirmPassword,onChange:e=>h(s=>({...s,confirmPassword:e.target.value}))}),x.confirmPassword&&a.jsx("p",{className:"text-sm text-red-500",children:x.confirmPassword})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-4 pt-4",children:[a.jsx(o.z,{type:"button",variant:"outline",onClick:()=>s(!1),children:"取消"}),a.jsx(o.z,{type:"submit",disabled:i,children:i?"修改中...":"修改密码"})]})]})]})}):null}var x=r(95248);function UserList(){let[e,s]=(0,t.useState)([]),[r,n]=(0,t.useState)(!0),[m,p]=(0,t.useState)(1),[u,w]=(0,t.useState)(!1),[j,f]=(0,t.useState)(null),[P,v]=(0,t.useState)(!1),[g,y]=(0,t.useState)(null),fetchUsers=async()=>{try{n(!0);let e=await fetch("/api/users");if(!e.ok)throw Error("Failed to fetch users");let r=await e.json();s(r)}catch(e){(0,c.Am)({variant:"destructive",description:"获取用户列表失败"})}finally{n(!1)}};(0,t.useEffect)(()=>{fetchUsers()},[]);let N=Math.ceil(e.length/20),C=(m-1)*20,b=e.slice(C,C+20),handlePageChange=e=>{p(e)},handleDeleteClick=e=>{y(e),v(!0)},handleDeleteConfirm=async()=>{if(g)try{let e=await fetch(`/api/users/${g}`,{method:"DELETE"});if(!e.ok){let s=await e.json();throw Error(s.error||"删除用户失败")}(0,c.Am)({description:"用户删除成功"}),fetchUsers()}catch(e){(0,c.Am)({variant:"destructive",description:e.message||"删除用户失败"})}finally{v(!1),y(null)}},handleEdit=e=>{f(e),w(!0)};return r?a.jsx("div",{className:"text-center py-4",children:"加载中..."}):(0,a.jsxs)("div",{className:"rounded-md border",children:[(0,a.jsxs)(l.iA,{children:[a.jsx(l.xD,{children:(0,a.jsxs)(l.SC,{children:[a.jsx(l.ss,{children:"用户名"}),a.jsx(l.ss,{children:"角色"}),a.jsx(l.ss,{children:"创建时间"}),a.jsx(l.ss,{className:"w-[100px]",children:"操作"})]})}),a.jsx(l.RM,{children:b.map(e=>(0,a.jsxs)(l.SC,{children:[a.jsx(l.pj,{className:"font-medium",children:e.username}),a.jsx(l.pj,{children:"admin"===e.role?"管理员":"核销员"}),a.jsx(l.pj,{children:new Date(e.createdAt).toLocaleDateString()}),a.jsx(l.pj,{children:(0,a.jsxs)("div",{className:"flex gap-2",children:[a.jsx(o.z,{variant:"ghost",size:"icon",onClick:()=>handleEdit(e),children:a.jsx(i.Z,{className:"h-4 w-4"})}),a.jsx(o.z,{variant:"ghost",size:"icon",onClick:()=>handleDeleteClick(e.id),children:a.jsx(d.Z,{className:"h-4 w-4"})})]})})]},e.id))})]}),N>1&&a.jsx("div",{className:"py-4 flex justify-center",children:a.jsx(h.tl,{children:(0,a.jsxs)(h.ng,{children:[a.jsx(h.nt,{children:a.jsx(h.dN,{onClick:()=>handlePageChange(m-1),disabled:1===m})}),Array.from({length:N}).map((e,s)=>a.jsx(h.nt,{children:a.jsx(h.kN,{onClick:()=>handlePageChange(s+1),isActive:m===s+1,children:s+1})},s)),a.jsx(h.nt,{children:a.jsx(h.$0,{onClick:()=>handlePageChange(m+1),disabled:m===N})})]})})}),a.jsx(EditUserModal,{open:u,onOpenChange:w,user:j,onSuccess:fetchUsers}),a.jsx(x.Q,{open:P,onOpenChange:v,title:"删除用户",description:"确定要删除这个用户吗？此操作不可恢复。",onConfirm:handleDeleteConfirm})]})}var w=r(14723);function AddUserModal({open:e,onOpenChange:s,onSuccess:r}){let[n,i]=(0,t.useState)(!1),[d,l]=(0,t.useState)({username:"",password:"",confirmPassword:"",role:""}),[h,x]=(0,t.useState)({}),validatePassword=e=>{if(e.length<8)return"密码长度至少8位";let s=0;return(/[A-Z]/.test(e)&&s++,/[a-z]/.test(e)&&s++,/[0-9]/.test(e)&&s++,/[^A-Za-z0-9]/.test(e)&&s++,s<3)?"密码需包含大写字母、小写字母、数字、特殊符号中的至少三种":""},validateForm=async()=>{let e={};d.username||(e.username="用户名不能为空"),d.password||(e.password="密码不能为空"),d.confirmPassword||(e.confirmPassword="确认密码不能为空"),d.role||(e.role="请选择角色");let s=validatePassword(d.password);if(s&&(e.password=s),d.password!==d.confirmPassword&&(e.confirmPassword="两次输入的密码不一致"),d.username&&!e.username)try{let s=await fetch("/api/users/check-username?username="+encodeURIComponent(d.username)),r=await s.json();r.available||(e.username="用户名已存在")}catch(s){e.username="验证用户名失败"}return x(e),0===Object.keys(e).length},handleSubmit=async e=>{e.preventDefault(),i(!0);try{let e=await validateForm();if(!e){i(!1);return}let a=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:d.username,password:d.password,role:d.role})});if(!a.ok){let e=await a.json();throw Error(e.error||"创建用户失败")}(0,c.Am)({description:"用户创建成功！"}),s(!1),r?.(),l({username:"",password:"",confirmPassword:"",role:""}),x({})}catch(e){(0,c.Am)({variant:"destructive",description:e.message||"创建用户失败，请重试"})}finally{i(!1)}};return a.jsx(m.Vq,{open:e,onOpenChange:s,children:(0,a.jsxs)(m.cZ,{children:[a.jsx(m.fK,{children:a.jsx(m.$N,{children:"新增用户"})}),(0,a.jsxs)("form",{onSubmit:handleSubmit,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx(u._,{htmlFor:"username",children:"用户名"}),a.jsx(p.I,{id:"username",value:d.username,onChange:e=>l(s=>({...s,username:e.target.value})),error:h.username}),h.username&&a.jsx("p",{className:"text-sm text-red-500",children:h.username})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx(u._,{htmlFor:"password",children:"密码"}),a.jsx(p.I,{id:"password",type:"password",value:d.password,onChange:e=>l(s=>({...s,password:e.target.value})),error:h.password}),h.password&&a.jsx("p",{className:"text-sm text-red-500",children:h.password})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx(u._,{htmlFor:"confirmPassword",children:"确认密码"}),a.jsx(p.I,{id:"confirmPassword",type:"password",value:d.confirmPassword,onChange:e=>l(s=>({...s,confirmPassword:e.target.value})),error:h.confirmPassword}),h.confirmPassword&&a.jsx("p",{className:"text-sm text-red-500",children:h.confirmPassword})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[a.jsx(u._,{htmlFor:"role",children:"角色"}),(0,a.jsxs)(w.Ph,{value:d.role,onValueChange:e=>l(s=>({...s,role:e})),children:[a.jsx(w.i4,{children:a.jsx(w.ki,{placeholder:"选择角色"})}),(0,a.jsxs)(w.Bw,{children:[a.jsx(w.Ql,{value:"admin",children:"管理员"}),a.jsx(w.Ql,{value:"user",children:"核销员"})]})]}),h.role&&a.jsx("p",{className:"text-sm text-red-500",children:h.role})]}),(0,a.jsxs)("div",{className:"flex justify-end space-x-2",children:[a.jsx(o.z,{variant:"outline",type:"button",onClick:()=>s(!1),children:"取消"}),a.jsx(o.z,{type:"submit",disabled:n,children:n?"创建中...":"确定"})]})]})]})})}function UsersPage(){let[e,s]=(0,t.useState)(!1),[r,i]=(0,t.useState)(0);return(0,a.jsxs)(n.AdminLayout,{children:[a.jsx("div",{className:"mb-4",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[a.jsx("h1",{className:"text-2xl font-bold",children:"用户管理"}),a.jsx(o.z,{variant:"default",onClick:()=>s(!0),children:"新增用户"})]})}),a.jsx(UserList,{},r),a.jsx(AddUserModal,{open:e,onOpenChange:s,onSuccess:()=>{i(e=>e+1)}})]})}},7498:(e,s,r)=>{"use strict";r.r(s),r.d(s,{$$typeof:()=>i,__esModule:()=>n,default:()=>o});var a=r(95153);let t=(0,a.createProxy)(String.raw`/Users/kele/Desktop/aicode/wallpaper-admin-last/app/users/page.tsx`),{__esModule:n,$$typeof:i}=t,d=t.default,o=d}};var s=require("../../webpack-runtime.js");s.C(e);var __webpack_exec__=e=>s(s.s=e),r=s.X(0,[6214,6426,3979,968,3157,1388,9071,4894,3124,6937,4333,5555,2025,7230,516,6842,6092],()=>__webpack_exec__(85966));module.exports=r})();